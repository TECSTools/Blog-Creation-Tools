<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Metadata Generator</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 3. Set Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple loader animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981; /* emerald-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Style for the copyable solution block */
        .solution-box {
            background-color: #f8fafc; /* gray-50 */
            border: 1px solid #e2e8f0; /* gray-200 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #1e293b; /* gray-800 */
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- === Header and Input Section === -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Image Metadata Generator</h1>
            <p class="text-gray-600 mt-2">Upload an image and provide context (URL, description) to generate all four required WordPress image fields.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Image Upload (Used for Name/Size) -->
                <div>
                    <label for="image-file" class="block text-sm font-medium text-gray-700">1. Image File Upload (For Name/Size)</label>
                    <input type="file" id="image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    <p id="file-info" class="mt-2 text-xs text-gray-500 italic hidden">File: <span id="file-name"></span> | Size: <span id="file-size"></span></p>
                </div>
                <!-- URL Input -->
                <div>
                    <label for="url-input" class="block text-sm font-medium text-gray-700">2. Blog Post URL (For SEO Context)</label>
                    <input type="url" id="url-input" placeholder="https://example.com/my-post" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <!-- Image Description -->
            <div class="mt-6">
                <label for="description-input" class="block text-sm font-medium text-gray-700">3. Image Content Description (CRITICAL)</label>
                <textarea id="description-input" rows="3" placeholder="Describe exactly what is in the image and its relevance to the post, e.g., 'A wide shot of the Crystal Serenity ship sailing into Miami at sunset. The post is about the 2026 Caribbean itineraries.'" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
            </div>

            <!-- Generate Button -->
            <button id="generate-button" class="w-full md:w-auto mt-6 px-8 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200" disabled>
                Generate Metadata
            </button>
        </div>

        <!-- === Loader === -->
        <div id="loader" class="hidden mx-auto mt-12 loader"></div>

        <!-- === Error Message === -->
        <div id="error-message" class="hidden mt-8 bg-red-100 border border-red-300 text-red-800 px-5 py-4 rounded-lg shadow-md">
            <!-- Error content injected by JS -->
        </div>

        <!-- === Results Section === -->
        <div id="results-container" class="hidden mt-8 space-y-4">
            <!-- Results injected by JS -->
        </div>
    </div>

    <script>
        // === DOM Elements ===
        const imageFileInput = document.getElementById('image-file');
        const urlInput = document.getElementById('url-input');
        const descriptionInput = document.getElementById('description-input');
        const generateButton = document.getElementById('generate-button');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const resultsContainer = document.getElementById('results-container');
        const fileInfo = document.getElementById('file-info');

        // === Constants ===
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const API_KEY = ""; // Placeholder for Canvas environment

        // === Event Listeners ===
        generateButton.addEventListener('click', runGeneration);
        imageFileInput.addEventListener('change', updateFileInfo);
        
        // Enable/Disable button based on inputs
        [urlInput, descriptionInput].forEach(input => {
            input.addEventListener('input', checkInputs);
        });
        imageFileInput.addEventListener('change', checkInputs);

        function checkInputs() {
            if (urlInput.value.trim() && descriptionInput.value.trim() && imageFileInput.files.length > 0) {
                generateButton.disabled = false;
            } else {
                generateButton.disabled = true;
            }
        }

        // === Helper: Update File Info Display ===
        function updateFileInfo() {
            const file = imageFileInput.files[0];
            if (file) {
                document.getElementById('file-name').innerText = file.name;
                document.getElementById('file-size').innerText = (file.size / 1024).toFixed(2) + ' KB';
                fileInfo.classList.remove('hidden');
            } else {
                fileInfo.classList.add('hidden');
            }
        }
        
        // === Main Generation Function ===
        async function runGeneration() {
            const url = urlInput.value.trim();
            const description = descriptionInput.value.trim();
            const file = imageFileInput.files[0];

            if (!file || !url || !description) {
                showError("Please fill out all fields and select an image file.");
                return;
            }
            
            const imageFileName = file.name;

            // 1. Set loading state
            loader.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.innerText = 'Analyzing...';
            errorMessage.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            resultsContainer.innerHTML = '';

            try {
                // 2. Generate Metadata via Gemini API
                const metadata = await generateMetadata(description, url, imageFileName);

                // 3. Display Results
                displayResults(metadata);

            } catch (error) {
                console.error("Metadata Generation Failed:", error);
                showError(`Generation Failed: ${error.message}`);
            } finally {
                // 4. Reset loading state
                loader.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerText = 'Generate Metadata';
            }
        }

        // === Helper: API Call to Gemini ===
        async function generateMetadata(imageDesc, postUrl, imageFileName) {
            const systemPrompt = "You are an expert SEO content creator for WordPress. Your task is to generate four specific metadata fields (Alt Text, Title, Caption, Description) for an image, optimized for SEO and readability. Output MUST be in the requested JSON format.";
            
            const userQuery = `Generate the following metadata fields for an image used in a blog post with the URL: "${postUrl}". The original image file name is "${imageFileName}". The image content and context is: "${imageDesc}".`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "altText": { "type": "STRING", "description": "SEO-optimized, descriptive text for accessibility, under 125 characters, including the primary keyword if possible." },
                            "title": { "type": "STRING", "description": "Short, catchy title for the media file, focusing on relevance." },
                            "caption": { "type": "STRING", "description": "Engaging, user-facing text displayed below the image on the blog post." },
                            "description": { "type": "STRING", "description": "Long, comprehensive, internal description for the media library/admin area." }
                        },
                        propertyOrdering: ["altText", "title", "caption", "description"]
                    }
                }
            };
            
            const apiUrl = `${GEMINI_API_URL}${API_KEY}`;
            let response;
            
            // Basic Exponential Backoff Retry Loop
            for (let i = 0; i < 3; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) {
                            return JSON.parse(jsonText);
                        } else {
                             throw new Error("API returned success but contained no parsable JSON output.");
                        }
                    } else if (response.status === 429 && i < 2) {
                        // Too Many Requests - Wait and retry
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        continue;
                    } else {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error.message || 'Unknown server error'}`);
                    }
                } catch (e) {
                    if (i === 2) throw e;
                    // Wait before next retry
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i + 1) * 1000));
                }
            }
            throw new Error("Maximum retry attempts reached.");
        }


        // === Helper: Show Error ===
        function showError(message) {
            errorMessage.innerHTML = `<p class="font-semibold">Error:</p><p>${message}</p>`;
            errorMessage.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
        }

        // === Helper: Copy to Clipboard ===
        function copyToClipboard(button) {
            const solutionElement = button.previousElementSibling;
            if (!solutionElement || !solutionElement.classList.contains('solution-box')) {
                console.error("Could not find solution text to copy.");
                return;
            }
            
            const textToCopy = solutionElement.innerText;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            textArea.style.position = 'fixed'; 
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                button.innerText = 'Copied!';
                setTimeout(() => {
                    button.innerText = 'Copy';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                button.innerText = 'Error';
            }

            document.body.removeChild(textArea);
        }

        // === Helper: Display Results ===
        function displayResults(metadata) {
            resultsContainer.classList.remove('hidden');
            
            const fieldMap = [
                { key: 'altText', title: '1. Alt Text', description: 'Used by screen readers and for SEO. Must be descriptive and keyword-focused.' },
                { key: 'title', title: '2. Title (Internal)', description: 'Used internally by WordPress media library and for hover text in some themes.' },
                { key: 'caption', title: '3. Caption (User-Facing)', description: 'Text that appears directly below the image on the blog post.' },
                { key: 'description', title: '4. Description (Media Library)', description: 'Long-form internal description for the WordPress media library.' }
            ];

            fieldMap.forEach(({ key, title, description }) => {
                const value = metadata[key] || "Generation Failed or Empty Value";

                const box = document.createElement('div');
                box.className = 'bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500';
                box.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                    <p class="text-xs text-gray-500 mb-2">${description}</p>
                    <div class="relative mt-2">
                        <pre class="solution-box">${value}</pre>
                        <button onclick="copyToClipboard(this)" class="absolute top-1 right-1 flex items-center space-x-1 bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-green-600 transition-all duration-200">
                            Copy
                        </button>
                    </div>
                `;
                resultsContainer.appendChild(box);
            });
        }
    </script>
</body>
</html>
